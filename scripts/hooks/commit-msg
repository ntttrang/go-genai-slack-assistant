#!/bin/bash

# Git commit-msg hook
# Validates commit message format follows conventional commits

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Skip merge commits
if echo "$COMMIT_MSG" | grep -qE "^Merge (branch|pull request)"; then
    echo -e "${GREEN}✓ Merge commit detected, skipping validation${NC}"
    exit 0
fi

# Skip revert commits
if echo "$COMMIT_MSG" | grep -qE "^Revert "; then
    echo -e "${GREEN}✓ Revert commit detected, skipping validation${NC}"
    exit 0
fi

# Regex pattern for conventional commits
# Format: type(scope): message
# or: type: message
PATTERN="^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .{1,}"

if ! echo "$COMMIT_MSG" | grep -qE "$PATTERN"; then
    echo -e "${RED}========================================${NC}"
    echo -e "${RED}ERROR: Invalid commit message format!${NC}"
    echo -e "${RED}========================================${NC}"
    echo -e "\n${YELLOW}Your commit message:${NC}"
    echo "$COMMIT_MSG"
    echo ""
    echo -e "${YELLOW}Expected format:${NC} type(scope): message"
    echo -e "${YELLOW}Example:${NC} feat(auth): add login functionality"
    echo ""
    echo -e "${YELLOW}Allowed types:${NC}"
    echo "  ${GREEN}feat${NC}     - New feature"
    echo "  ${GREEN}fix${NC}      - Bug fix"
    echo "  ${GREEN}docs${NC}     - Documentation only changes"
    echo "  ${GREEN}style${NC}    - Code style changes (formatting, etc)"
    echo "  ${GREEN}refactor${NC} - Code refactoring"
    echo "  ${GREEN}test${NC}     - Adding or updating tests"
    echo "  ${GREEN}chore${NC}    - Maintenance tasks"
    echo "  ${GREEN}perf${NC}     - Performance improvements"
    echo "  ${GREEN}ci${NC}       - CI/CD changes"
    echo "  ${GREEN}build${NC}    - Build system changes"
    echo "  ${GREEN}revert${NC}   - Revert previous commit"
    echo ""
    echo -e "${YELLOW}Scope is optional but recommended:${NC}"
    echo "  feat(slack): add event processor"
    echo "  fix(api): handle nil pointer error"
    echo ""
    exit 1
fi

echo -e "${GREEN}✓ Commit message format is valid${NC}"
exit 0
